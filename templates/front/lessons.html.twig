{% extends 'base.html.twig' %}

{% block title %}
    {% if lesson is defined %}
        Le√ßon : {{ lesson.title }}
    {% else %}
        Cours : {{ course.title }}
    {% endif %}
{% endblock %}

{% block body %}
<div class="container my-5">

    {% if lesson is defined %}
        <div class="card shadow-sm rounded-3 mb-4 p-4">
            <h1 class="h4 text-primary mb-3">üìò Le√ßon : {{ lesson.title }}</h1>

            {% if lesson.content %}
                <section class="mt-3">
                    <h3>Contenu :</h3>
                    <div>{{ lesson.content|raw }}</div>
                </section>
            {% else %}
                <p class="text-muted mt-3">Aucun contenu disponible pour cette le√ßon.</p>
            {% endif %}

            <section class="mt-4">
                <h3>Vid√©o :</h3>
                {% if lesson.videoUrl %}
                    {% set cleanUrl = lesson.videoUrl|split('&')[0] %}
                    {% set embedUrl = cleanUrl
                        | replace({'https://www.youtube.com/watch?v=': 'https://www.youtube.com/embed/'})
                        | replace({'https://youtu.be/': 'https://www.youtube.com/embed/'}) %}
                    <div class="ratio ratio-16x9 mt-2">
                        <iframe src="{{ embedUrl }}" frameborder="0" allowfullscreen></iframe>
                    </div>
                {% else %}
                    <p class="text-muted">Aucune vid√©o disponible pour cette le√ßon.</p>
                {% endif %}
            </section>

            {% if hasValidated %}
                <p class="text-success fw-bold mt-3">‚úÖ Cette le√ßon est valid√©e</p>
            {% else %}
                <form action="{{ path('front_lesson_validate', {'id': lesson.id}) }}" method="POST" class="mt-3">
                    <button type="submit" class="btn btn-success">Valider la le√ßon</button>
                </form>
            {% endif %}

            <a href="{{ path('front_course_lessons', {'id': course.id}) }}" class="btn btn-secondary mt-4">‚Üê Retour aux le√ßons</a>
        </div>

    {% else %}
        <div class="card shadow-sm rounded-3 mb-4 p-4">
            <h1 class="h4 text-primary mb-3">üìñ Cours : {{ course.title }}</h1>
            {% if course.description %}
                <div>{{ course.description|raw }}</div>
            {% endif %}
        </div>

        <h2 class="mb-3">Le√ßons disponibles :</h2>
        <div class="row g-3 mb-4">
            {% for lesson in course.lessons %}
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column justify-content-between">
                            <h5 class="card-title">{{ lesson.title }}</h5>
                            
                            {% if lesson.content %}
                                <div class="card-text lesson-content">{{ lesson.content|raw }}</div>
                            {% endif %}

                            {% if lesson.videoUrl %}
                                <h6 class="mt-3">Vid√©o :</h6>
                                {% set cleanUrl = lesson.videoUrl|split('&')[0] %}
                                {% set embedUrl = cleanUrl
                                    | replace({'https://www.youtube.com/watch?v=': 'https://www.youtube.com/embed/'})
                                    | replace({'https://youtu.be/': 'https://www.youtube.com/embed/'}) %}
                                <div class="ratio ratio-16x9">
                                    <iframe src="{{ embedUrl }}" frameborder="0" allowfullscreen></iframe>
                                </div>
                            {% endif %}

                            {# --- Gestion des boutons --- #}
                            {% if isCoursePurchased %}
                                {% if lesson.id in purchasedLessonIds %}
                                    <a href="{{ path('front_lesson_show', {'id': lesson.id}) }}" class="btn btn-success w-100 mt-3">
                                        Consulter la le√ßon
                                    </a>
                                {% else %}
                                    <form class="stripe-checkout-lesson" action="{{ path('stripe_checkout_lesson', {'id': lesson.id}) }}" method="POST">
                                        <button type="submit" class="btn btn-primary w-100 mt-3">
                                            Acheter la le√ßon - {{ lesson.price }} ‚Ç¨
                                        </button>
                                    </form>
                                {% endif %}
                            {% else %}
                                <button class="btn btn-secondary w-100 mt-3" disabled>
                                    Acheter le√ßon (Cours non achet√©)
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="text-center mt-4">
            <a href="{{ path('front_dashboard') }}" class="btn btn-secondary">
                ‚Üê Retour au dashboard
            </a>
        </div>
    {% endif %}

</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe("{{ stripePublicKey|default('') }}");

document.querySelectorAll('.stripe-checkout-lesson').forEach(form => {
    form.addEventListener('submit', e => {
        e.preventDefault();
        fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
            if (data.id) {
                stripe.redirectToCheckout({ sessionId: data.id });
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Erreur lors de la cr√©ation de la session Stripe.");
        });
    });
});
</script>
{% endblock %}
