{% extends 'base.html.twig' %}

{% block title %}Tableau de bord{% endblock %}

{% block body %}
<div class="container my-5">
    <h1 class="text-primary text-center mb-4">üìñ Tableau de bord {{ user.email }}</h1>

    {% set hasAnyPurchased = false %}

    {% for theme in themes %}
        {% set purchasedCourses = [] %}
        {% set purchasedLessons = [] %}

        {% for courseWrapper in theme.accessibleCourses %}
            {% set lessonsBought = courseWrapper.lessons|filter(lw => lw.hasAccess) %}
            {% if courseWrapper.hasAccess %}
                {% set purchasedCourses = purchasedCourses|merge([{
                    'entity': courseWrapper.entity,
                    'lessons': lessonsBought
                }]) %}
            {% elseif lessonsBought|length > 0 %}
                {% set purchasedCourses = purchasedCourses|merge([{
                    'entity': courseWrapper.entity,
                    'lessons': lessonsBought
                }]) %}
            {% endif %}
        {% endfor %}

        {% if purchasedCourses|length > 0 %}
            {% set hasAnyPurchased = true %}
            <h2 class="mt-4">{{ theme.name }}</h2>
            <div class="row g-3">

                {% for courseItem in purchasedCourses %}
                    {% set course = courseItem.entity %}
                    {% set lessonsBought = courseItem.lessons %}

                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100 shadow-sm">

                            <img
                                src="{{ asset('images/courses.png') }}"
                                class="card-img-top p-2"
                                alt="{{ course.title }}"
                                style="max-height: 140px; width: 100%; object-fit: contain;"
                            >

                            <div class="card-body d-flex flex-column justify-content-between">
                                <h5 class="card-title">{{ course.title }}</h5>
                                <p class="card-text"><strong>Prix :</strong> {{ course.price }} ‚Ç¨</p>

                                <a href="{{ path('front_course_show', {'id': course.id}) }}" class="btn btn-success w-100 mt-3">
                                    Consulter le cours
                                </a>

                                {% if lessonsBought|length > 0 and lessonsBought|length < course.lessons|length %}
                                    <ul class="list-group mt-2">
                                        {% for lessonWrapper in lessonsBought %}
                                            <li class="list-group-item">{{ lessonWrapper.entity.title }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}

                            </div>
                        </div>
                    </div>
                {% endfor %}

            </div>
        {% endif %}
    {% endfor %}

    {% if not hasAnyPurchased %}
        <div class="alert alert-info text-center mt-2">
            Vous n'avez encore achet√© aucun cours ni le√ßon.
        </div>
    {% endif %}

    <div class="mt-4 text-center">
        <a href="{{ path('front_themes') }}" class="btn btn-secondary">‚Üê Retour aux th√®mes</a>
        <a href="{{ path('front_certifications') }}" class="btn btn-success ms-2">üèÜ Mes Certifications</a>
    </div>
</div>
{% endblock %}
