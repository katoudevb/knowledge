{% extends 'base.html.twig' %}

{% block title %}Cours pour le th√®me : {{ theme.name }}{% endblock %}

{% block body %}
<div class="container my-5">
    <h1 class="text-primary text-center mb-4">üìö Cours pour le th√®me : {{ theme.name }}</h1>

    {% set purchasedLessonIdsByCourse = purchasedLessonIdsByCourse|default({}) %}
    {% set purchasedCourses = purchasedCourses|default([]) %}

    {% if theme.courses|length > 0 %}
        <div class="row g-3">
            {% for course in theme.courses %}
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm mb-3">
                        <div class="card-body d-flex flex-column justify-content-between">
                            <h5 class="card-title">{{ course.title }}</h5>
                            <p class="card-text"><strong>Prix du cours :</strong> {{ course.price }} ‚Ç¨</p>

                            {% set purchasedLessonIds = purchasedLessonIdsByCourse[course.id]|default([]) %}
                            {% set coursePurchased = course.id in purchasedCourses %}
                            {% set allLessonsPurchased = course.lessons|length > 0 and course.lessons|length == purchasedLessonIds|length %}

                            {# Affiche les le√ßons avec les boutons appropri√©s #}
                            {% for lesson in course.lessons %}
                                {% set hasLessonAccess = lesson.id in purchasedLessonIds %}
                                <div class="mb-2">
                                    {% if hasLessonAccess or coursePurchased %}
                                        <a href="{{ path('front_lesson_show', {'id': lesson.id}) }}" class="btn btn-success w-100 mb-1">
                                            Consulter la le√ßon {{ lesson.title }}
                                        </a>
                                    {% else %}
                                        <strong>{{ lesson.title }}</strong>
                                        <form class="stripe-form mt-1"
                                              action="{{ path('stripe_checkout_lesson', {'id': lesson.id}) }}"
                                              method="POST" data-turbo="false">
                                            <button type="button" class="btn btn-primary w-100">
                                                Acheter la le√ßon - {{ lesson.price }} ‚Ç¨
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            {% endfor %}

                            {# Affiche le bouton pour acheter le cours complet uniquement si le cours n'est pas achet√© et toutes les le√ßons ne sont pas achet√©es #}
                            {% if not coursePurchased and not allLessonsPurchased %}
                                <form class="stripe-form mt-2"
                                      action="{{ path('stripe_checkout_course', {'id': course.id}) }}"
                                      method="POST" data-turbo="false">
                                    <button type="button" class="btn btn-secondary w-100">
                                        Acheter le cours complet - {{ course.price }} ‚Ç¨
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info text-center">
            Aucun cours disponible pour ce th√®me pour le moment.
        </div>
    {% endif %}

    <div class="mt-4 text-center">
        <a href="{{ path('front_themes') }}" class="btn btn-secondary">‚Üê Retour aux th√®mes</a>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
function initStripeButtons() {
    const stripe = Stripe("{{ stripePublicKey|default('') }}");

    document.querySelectorAll('.stripe-form').forEach(form => {
        const button = form.querySelector('button[type="button"]');
        if (!button) return;

        button.replaceWith(button.cloneNode(true));
        const newButton = form.querySelector('button[type="button"]');

        newButton.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await res.json();
                if (data.id) {
                    await stripe.redirectToCheckout({ sessionId: data.id });
                } else if (data.error) {
                    alert(data.error);
                } else {
                    alert("Erreur inconnue lors de la cr√©ation de la session Stripe.");
                }
            } catch (err) {
                console.error(err);
                alert("Erreur lors de la communication avec le serveur.");
            }
        });
    });
}

document.addEventListener('DOMContentLoaded', initStripeButtons);
document.addEventListener('turbo:load', initStripeButtons);
</script>
{% endblock %}
